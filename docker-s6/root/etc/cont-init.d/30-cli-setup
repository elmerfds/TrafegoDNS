#!/command/with-contenv bash

echo "**** Setting up CLI tool access ****"

# Ensure CLI scripts are executable
chmod +x /app/bin/trafego
chmod +x /usr/local/bin/trafego
chmod +x /usr/bin/trafego

# Add the in-container script for direct access
cp /app/docker-s6/scripts/cli-inside-container.sh /usr/local/bin/trafego-with-app
chmod +x /usr/local/bin/trafego-with-app

# Replace the standard CLI with the in-container version
mv /usr/local/bin/trafego /usr/local/bin/trafego-direct
ln -sf /usr/local/bin/trafego-with-app /usr/local/bin/trafego

# Create a simple DNS view command
cat > /usr/local/bin/view-dns << 'EOF'
#!/bin/bash
trafegodns records
EOF

chmod +x /usr/local/bin/view-dns

# Install the unified CLI tool
cp /app/docker-s6/scripts/unified-cli.sh /usr/local/bin/trafegodns
chmod +x /usr/local/bin/trafegodns

# Create symlinks for common commands
ln -sf /usr/local/bin/trafegodns /usr/local/bin/trafego-records
ln -sf /usr/local/bin/trafegodns /usr/local/bin/db-records
ln -sf /usr/local/bin/trafegodns /usr/local/bin/process-dns
ln -sf /usr/local/bin/trafegodns /usr/local/bin/dns-status

# Run environment setup script
/app/docker-s6/scripts/setup-env.sh

# Verify that the CLI tool is available
if [ -x "$(command -v trafego)" ]; then
  echo "**** CLI tool 'trafego' is available in PATH ****"
else
  echo "**** WARNING: CLI tool 'trafego' is not available in PATH ****"
fi

# Set up database directory if needed
mkdir -p /config/data
chown -R abc:abc /config/data

echo "**** CLI setup complete ****"