# /etc/cont-init.d/20-config

#!/command/with-contenv bash

LOG_LEVEL=${LOG_LEVEL:-INFO}
API_PORT=${API_PORT:-3000}

echo
echo "-------------------------------------"
echo "Directory Permissions and App Setup"
echo "-------------------------------------"

# Make sure the config directory has correct permissions
echo "Setting permissions on config directory"
chown abc:abc /config

# If the config directory is mounted but empty, create a basic structure
if [ -d /config ] && [ ! "$(ls -A /config)" ]; then
  echo "Config directory is empty, creating initial structure"
  mkdir -p /config/data
  chown -R abc:abc /config
fi

# Check if app data file exists and make sure it has correct permissions
if [ -f /app/dns-records.json ]; then
  echo "Setting permissions on app data file"
  chown abc:abc /app/dns-records.json
fi

# Ensure we're using the enhanced version
if [ ! -L /app/src/app.js ] && [ -f /app/src/app-enhanced.js ]; then
  echo "Setting up enhanced app version as default"
  mv /app/src/app.js /app/src/app.js.orig
  ln -sf /app/src/app-enhanced.js /app/src/app.js
  echo "Enhanced application with API support will be used"
fi

# Set up API port
echo "Setting up API port: ${API_PORT}"
export API_PORT=${API_PORT}

# Prepare Web UI directory if present
if [ -d /app/webui/dist ]; then
  echo "Web UI detected, setting permissions"
  chown -R abc:abc /app/webui
fi

echo "Directory and app setup complete"
echo "-------------------------------------"