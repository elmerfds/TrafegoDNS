#!/command/with-contenv bash

LOG_LEVEL=${LOG_LEVEL:-INFO}

echo
echo "-------------------------------------"
echo "Directory Permissions Setup"
echo "-------------------------------------"

# Make sure the config directory has correct permissions
echo "Setting permissions on config directory"
chown -R abc:abc /config

# If the config directory is mounted but empty, create a basic structure
if [ -d /config ] && [ ! "$(ls -A /config)" ]; then
  echo "Config directory is empty, creating initial structure"
  mkdir -p /config/data
  chown -R abc:abc /config
fi

# Ensure database directory exists with correct permissions
echo "Setting up database directory"
mkdir -p /config/data
chown -R abc:abc /config/data
chmod 755 /config/data

# If database exists, ensure it has correct permissions
if [ -f /config/data/trafegodns.db ]; then
  echo "Setting permissions on SQLite database file"
  chown abc:abc /config/data/trafegodns.db
  chmod 644 /config/data/trafegodns.db
else
  echo "No database file found. A new one will be created on first run."
fi

# Run database migration script if needed
if [ -f "/app/docker-s6/scripts/add-last-processed.sh" ]; then
  echo "Checking and updating database schema if needed..."
  chmod +x /app/docker-s6/scripts/add-last-processed.sh
  s6-setuidgid abc /app/docker-s6/scripts/add-last-processed.sh
fi

# Check for JSON files and migrations
if [ -f "/app/docker-s6/scripts/manage-json-files.sh" ]; then
  chmod +x /app/docker-s6/scripts/manage-json-files.sh
  echo "Checking JSON files and migration status..."
  s6-setuidgid abc /app/docker-s6/scripts/manage-json-files.sh
else
  # Fallback to basic migration status check
  if [ -f /config/data/trafegodns.db ] && [ -f /config/data/.json_migration_complete ]; then
    echo "JSON migration has been completed. Original files are preserved."
  else
    echo "JSON migration status unknown. Files will be migrated if needed."
  fi
fi

echo "Directory setup complete"
echo "-------------------------------------"