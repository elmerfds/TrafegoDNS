#!/command/with-contenv bash

LOG_LEVEL=${LOG_LEVEL:-INFO}
# Force SQLite-only mode (permanently disable JSON files)
export DISABLE_JSON_STORAGE=true

echo
echo "-------------------------------------"
echo "Directory Permissions Setup"
echo "-------------------------------------"

# Make sure the config directory has correct permissions
echo "Setting permissions on config directory"
chown -R abc:abc /config

# If the config directory is mounted but empty, create a basic structure
if [ -d /config ] && [ ! "$(ls -A /config)" ]; then
  echo "Config directory is empty, creating initial structure"
  mkdir -p /config/data
  chown -R abc:abc /config
fi

# Ensure database directory exists with correct permissions
echo "Setting up database directory"
mkdir -p /config/data
chown -R abc:abc /config/data
chmod 755 /config/data

# If database exists, ensure it has correct permissions
if [ -f /config/data/trafegodns.db ]; then
  echo "Setting permissions on SQLite database file"
  chown abc:abc /config/data/trafegodns.db
  chmod 644 /config/data/trafegodns.db
else
  echo "No database file found. A new one will be created on first run."
fi

# SQLite is now exclusively used - JSON storage is permanently disabled
echo "üîí SQLite-only mode is enforced - JSON storage is permanently disabled"

# Always remove any existing DNS records JSON files
JSON_FILES_REMOVED=false

# Check config directory for JSON files
if [ -f /config/data/dns-records.json ]; then
  echo "Found existing DNS records JSON file - backing up and removing"
  mv /config/data/dns-records.json /config/data/dns-records.json.bak.$(date +%s)
  JSON_FILES_REMOVED=true
fi

# Check app directory for legacy JSON files
if [ -f /app/dns-records.json ]; then
  echo "Found legacy DNS records JSON file - backing up and removing"
  mv /app/dns-records.json /config/data/dns-records.json.legacy.bak.$(date +%s)
  JSON_FILES_REMOVED=true
fi

# Check current working directory
if [ -f ./dns-records.json ]; then
  echo "Found DNS records JSON file in current directory - backing up and removing"
  mv ./dns-records.json /config/data/dns-records.json.cwd.bak.$(date +%s)
  JSON_FILES_REMOVED=true
fi

# Confirm no JSON files remain
if [ "$JSON_FILES_REMOVED" = "true" ]; then
  echo "‚úÖ All DNS records JSON files have been backed up and removed"
else
  echo "‚úÖ No DNS records JSON files found - SQLite will be used exclusively"
fi

# Run database migration script if needed
if [ -f "/app/docker-s6/scripts/add-last-processed.sh" ]; then
  echo "Checking and updating database schema if needed..."
  chmod +x /app/docker-s6/scripts/add-last-processed.sh
  s6-setuidgid abc /app/docker-s6/scripts/add-last-processed.sh
fi

# Check for JSON files and migrations
if [ -f "/app/docker-s6/scripts/manage-json-files.sh" ]; then
  chmod +x /app/docker-s6/scripts/manage-json-files.sh
  echo "Checking JSON files and migration status..."
  s6-setuidgid abc /app/docker-s6/scripts/manage-json-files.sh
else
  # Fallback to basic migration status check
  if [ -f /config/data/trafegodns.db ] && [ -f /config/data/.json_migration_complete ]; then
    echo "JSON migration has been completed. Original files are preserved."
  else
    echo "JSON migration status unknown. Files will be migrated if needed."
  fi
fi

# Run fix-sqlite script to ensure better-sqlite3 is installed and configured
if [ -f "/app/docker-s6/scripts/fix-sqlite.sh" ]; then
  echo "Running SQLite fix script to ensure proper database initialization..."
  chmod +x /app/docker-s6/scripts/fix-sqlite.sh
  /app/docker-s6/scripts/fix-sqlite.sh
else
  echo "‚ö†Ô∏è SQLite fix script not found - skipping database fix"
fi

echo "Directory setup complete"
echo "-------------------------------------"